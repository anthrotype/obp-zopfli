env:
  global:
    # directory containing the project source
    - REPO_DIR=.
    # pip dependencies to _build_ project
    - BUILD_DEPENDS=
    # pip dependencies to _test_ project
    - TEST_DEPENDS="tox"
    - PLAT=x86_64
    - UNICODE_WIDTH=32

language: python
# The travis Python version is unrelated to the version we build and test
# with.  This is set with the MB_PYTHON_VERSION variable.
python: 3.5
sudo: required
dist: trusty
services: docker

matrix:
  exclude:
    # Exclude the default Python 3.5 build
    - python: 3.5
  include:
    - os: linux
      env: MB_PYTHON_VERSION=2.7
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=2.7
        - PLAT=i686
        - UNICODE_WIDTH=16
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.5
        - PLAT=i686
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - BUILD_SDIST=true
    - os: linux
      env:
        - MB_PYTHON_VERSION=3.6
        - PLAT=i686
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=2.7
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.5
    - os: osx
      language: generic
      env:
        - MB_PYTHON_VERSION=3.6

before_install:
  - source multibuild/common_utils.sh
  - source multibuild/travis_steps.sh
  - before_install

install:
  - build_wheel $REPO_DIR $PLAT

script:
  - install_run $PLAT

after_success:
  # if tagged commit, create the source distribution for the deploy stage, and
  # copy the wheel to dist/ where we can upload both in one go to PyPI/Github
  - >-
    if [ -n "$TRAVIS_TAG" ]; then
        if [ "$BUILD_SDIST" == true ]; then
            pip install --upgrade setuptools;
            python setup.py sdist;
        fi;
        mkdir -p dist;
        cp wheelhouse/*.whl dist;
    fi

deploy:
  # Deploy on tags to GitHub Releases
  - provider: releases
    api_key:
      secure: C5BF1X3MQPGNlURe+ODjsY+iDqfCEhS5+kIHW2CoEGeWis5ipBJ0lDD4myvIt5KWYl3x37wl2S7KiYhTf/O66xCaqyNH6oPCNb0/7cC+nEl1a8Ok0i5erguioD4JdUzCMgUWw5iTUQ9TQk9jr1WrJq9U/oEuVQgsTyIb7uQip9kGVMGw1epZxrE6wreYB4+zoF2uHztJRJFz+TAyDieiBZM3JYgNkGjr65iHjBgAPTg39lnGH4SgDelOspbT+aLsDZ4rpjWFzVNb3IX3puH47RNHnVyHADKET9fblBjGsV0M5Zb5Eu+ZhYnorLBhDPFLG1Qs4ISOfOEfAu/5OIhoIQg+fqklMTeTnVi21qx/1wy4lhmcJNzXFV36n52FNQD04OaQ4uD8qozYu4ORgh6bdhZr64lK48TKaBqyMBZ+Oe75OQ/hC41oXTXkVnwaPbmnpNesQfHWfYXpViD7q6YKirdWqS8a9eN8b2dspdB3iCbW7dDRzfCX6A4k6QDl3VOxfdNhQptY50kdIv3NCPkMAse4yOhxFtk27DPM7Jr2QciyasQFQ0xAIXhgSoGQWvDK4wCEa1bCL+dZ//cCTt6+62Hr6B8mlWjWSE0VRBMjWTWvhuhnLZ1Ccqg2NurqER+tllhIrjunegdY5tiWKzrhw3/Y302sbXpqIEcarUqlZVA=
    file_glob: true
    file: "dist/*"
    skip_cleanup: true
    on:
      repo: anthrotype/obp-zopfli
      tags: true
#   # Deploy on tags to PyPI
#   - provider: pypi
#     server: https://upload.pypi.org/legacy/
#     on:
#       repo: anthrotype/obp-zopfli
#       tags: true
#     user: anthrotype
#     password:
#       secure: O7n0blUsuJRHOVMRnIntntwQfpwvrUdDJOYU6MThNAP7VmoZCClHcrRa72zYy/rloEfvLoftdqRgWMvany5rETfb5l//zlKlRxYUnE8UMrRm/b6Q10OWH1PDuLDZ7o1Q97gFaECfoW8s1fygKF41RxiwBlFM9JdWgIaT3S5PNKO16sj50oFs6/Xd4MOeYhVPwj3SBL7Rn0cs2cLXvcUfMiWJ0czl90p9vQpjr5y9OzG87/kSr5Xo7CxoSJg0OHoQNPoGAAuSE6e/Lsg9fVSmqmYcYS/YsCuWb/3UiWrW34JPh5IasK8N0FBJ18j4KPDI5hywKiF8aqSFcvC0QvpBcnx/gSQtOObmnayHnyaJhfnJUcBB2kF0FSO+x4dZqiqtoy08IuIJMiYAgxFtVXXiIGFS4esFaJLQq4n4KhpXXEVn4LWpiBTt5oAvinygttMO/BlirPaaSmgYOf0tZwzQZiv79i6Q+ag6Y5/njYLfZKi23I9YC8qtZUpBoaSpgGeUki1KAChM7EaU/sFQEAEdGSxCIjPzZtE32FokIugZe/q/ov5hINLpy9W0Cb9M7Ma7EqAFFR8VabY6cYupJgDsSwcIgNQZD2CgXe2J83XmNMvkbULuRtGktiXNtNp6eL1OTYLvb/fS+Dp9Nw0VNuBNJFcbHCVN1h0+yfA9mAFTYSI=
#     skip_cleanup: true
#     distributions: pass
